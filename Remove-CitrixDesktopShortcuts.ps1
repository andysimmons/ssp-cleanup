<#
.NOTES
    Name:    Remove-CitrixDesktopShortcuts.ps1
    Author:  Andy Simmons
    Version: 1.0.2
    URL:     https://github.com/andysimmons/ssp-cleanup
    
.SYNOPSIS
    Removes desktop shortcuts generated by the Citrix Self Service Plugin.

.DESCRIPTION
    This script was written to work around a bug where the Citrix Self
    Service Plugin (SSP) creates shortcuts on a user's desktop, and RES 
    Workspace Manager then saves the SSP shortcuts in their persistent profile.

    At logoff, RES WM performs its final profile sync, and then Citrix SSP removes
    the shortcuts from the desktop, resulting in duplicate shortcuts that accumulate
    with each successive logon.

    This script can be invoked at logon to remove the leftover shortcuts before
    SSP creates additional copies of them.

.PARAMETER StupidTargetPattern
    Regular expression used to determine (by target path) if a shortcut was created
    by the Citrix Self-Service Plugin.

.PARAMETER ShortcutPath
    Directory to be searched (non-recursively) and purged of SSP shortcuts.

.PARAMETER LogFile
    Log file location.
    
.EXAMPLE
    Remove-CitrixDesktopShortcuts.ps1

    Deletes any .lnk files in the user's desktop directory that were generated
    by the Citrix SSP plugin.

.EXAMPLE
    Remove-CitrixDesktopShortcuts.ps1 -WhatIf

    Shows which shortcut files would be deleted, but doesn't actually remove them.
#>
[CmdletBinding(SupportsShouldProcess, ConfirmImpact = 'Medium')]
param 
(
    [regex]
    $StupidTargetPattern = 'Citrix.*ICA.*SelfServicePlugin',

    [IO.DirectoryInfo]
    $ShortcutPath = [Environment]::GetFolderPath('DesktopDirectory'),

    [IO.FileInfo]
    $LogFile = 'C:\Logs\CitrixSSPCleanup.log'
)

# This is a login script, we'll be explicit with modules to keep it snappy.
$PSModuleAutoLoadingPreference = 'None'

$scriptModules = @(
    'Microsoft.PowerShell.Host',
    'Microsoft.PowerShell.Management',
    'Microsoft.PowerShell.Security',
    'Microsoft.PowerShell.Utility'
)
$scriptModules | Import-Module

# Try the cool/newer Start-Transcript if we can
try   { Start-Transcript -IncludeInvocationHeader $LogFile }
catch 
{ 
    try   { Start-Transcript $LogFile }
    catch 
    { 
        Write-Warning "Couldn't write to log file '${LogFile}'. Continuing without logging."
        Write-Warning $_.Exception.Message
    }
}

if (-not $ShortcutPath.Exists)
{
    Write-Error -Message "No such directory: '${ShortcutPath}'" -Category ObjectNotFound
    exit 1
}

[IO.FileInfo[]]$lnkFiles = Get-ChildItem -Path $ShortcutPath -Filter '*.lnk' -ErrorAction Stop
Write-Verbose "Found $($lnkFiles.Length) '.lnk' files in '${ShortcutPath}'"

if (-not $lnkFiles) { exit }

# Spawn a WSH shell (.Net doesn't have a native shortcut handler).
$wshShell = New-Object -ComObject WScript.Shell 

foreach ($lnkFile in $lnkFiles)
{
    try 
    {
        # Create a shortcut (COM object) from each file. 
        $shortcut = $wshShell.CreateShortcut($lnkFile.FullName) 
    }
    catch
    {
        Write-Error -Message $_.Exception.Message -Category $_.CategoryInfo
        $shortcut = $null
        continue
    }

    if ($shortcut.TargetPath -match $StupidTargetPattern)
    {
        Write-Verbose "SSP Shortcut: '$($lnkFile.BaseName)' -> '$($shortcut.TargetPath)'"
        if ($PSCmdlet.ShouldProcess($lnkFile, 'Delete'))
        {
            try
            {
                $lnkFile.Delete()
                "SSP Shortcut Removed: $lnkFile"
            }
            catch
            {
                Write-Warning "Delete FAILED for SSP Shortcut: $lnkFile"
                Write-Warning $_.Exception.Message
            }
        }
    }
}
