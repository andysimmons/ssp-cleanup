<#	
.NOTES
    Name:    Remove-CitrixDesktopShortcuts.ps1
    Author:  Andy Simmons
    Version: 1.0.1
    URL:     https://github.com/andysimmons/ssp-cleanup
    
.SYNOPSIS
    Removes desktop shortcuts generated by the Citrix Self Service Plugin.

.DESCRIPTION
    This script was written to work around a bug where the Citrix Self
    Service Plugin (SSP) creates shortcuts on a user's desktop, and RES 
    Workspace Manager then saves the SSP shortcuts in their persistent profile.

    At logoff, RES WM performs its final profile sync, and then Citrix SSP removes
    the shortcuts from the desktop, resulting in duplicate shortcuts that accumulate
    with each successive logon.

    This script can be invoked at logon to remove the leftover shortcuts before
    SSP creates additional copies of them.

.PARAMETER StupidTargetPattern
    Regular expression used to determine (by target path) if a shortcut was created
    by the Citrix Self-Service Plugin.

.PARAMETER ShortcutPath
    Directory to be searched (non-recursively) and purged of SSP shortcuts.
    
.EXAMPLE
    Remove-CitrixDesktopShortcuts.ps1

    Deletes any .lnk files in the user's desktop directory that were generated
    by the Citrix SSP plugin.

.EXAMPLE
    Remove-CitrixDesktopShortcuts.ps1 -WhatIf

    Shows which shortcut files would be deleted, but doesn't actually remove them.
#>
[CmdletBinding(SupportsShouldProcess, ConfirmImpact = 'Medium')]
param (
    [regex]
    $StupidTargetPattern = 'Citrix.*ICA.*SelfServicePlugin',

    [IO.DirectoryInfo]
    $ShortcutPath = [Environment]::GetFolderPath('DesktopDirectory')
)

if ($ShortcutPath.Exists)
{
    # Populate an array with any .lnk files in the current user's desktop directory.
    [IO.FileInfo[]]$lnkFiles = Get-ChildItem -Path $ShortcutPath -Filter '*.lnk' -ErrorAction Stop
    
    # There's currently no .Net class to handle shortcuts natively, so if we found
    # any *.lnk files, we need WSH to crack them open.
    if ($lnkFiles) { $wshShell = New-Object -ComObject WScript.Shell }
    else           { exit }

    foreach ($lnkFile in $lnkFiles)
    {
        # Create a "shortcut" (a COM object) from the file info
        try 
        { 
            $shortcut = $wshShell.CreateShortcut($lnkFile.FullName) 
        }
        catch
        {
            Write-Error -Message $_.Exception.Message -Category $_.CategoryInfo
            $shortcut = $null
            continue
        }
        
        # If it came from SSP, nuke it.
        if ($shortcut.TargetPath -match $StupidTargetPattern)
        {
            if ($PSCmdlet.ShouldProcess($lnkFile, 'Delete'))
            {
                $lnkFile.Delete()	
            }
        }
    }
}
